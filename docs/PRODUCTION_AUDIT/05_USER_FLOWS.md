# 05 - مسارات المستخدمين (User Flows)

## تاريخ التدقيق: 2026-01-26

---

## 1. نظرة عامة على الأدوار

| الدور | الوصف | البوابة | الصلاحيات الرئيسية |
|-------|-------|---------|-------------------|
| Admin | مدير النظام | Dashboard | كل شيء |
| Manager | مشرف | Dashboard | إدارة العملاء والفريق |
| Writer | كاتب محتوى | Dashboard | كتابة وتعديل البوستات |
| Designer | مصمم | Dashboard | تصميم ورفع الملفات |
| Client | عميل | Client Portal | عرض + موافقة/رفض |

---

## 2. Admin Flow (مدير النظام)

### 2.1 مخطط التدفق

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              ADMIN FLOW                                      │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌──────────┐
    │  Login   │
    └────┬─────┘
         │
         ▼
    ┌──────────────────────────────────────────────────────────────┐
    │                      DASHBOARD                                │
    │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐         │
    │  │Calendar │  │  Grid   │  │ Kanban  │  │  List   │         │
    │  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘         │
    │       └────────────┴────────────┴────────────┘               │
    │                         │                                     │
    │                         ▼                                     │
    │              ┌─────────────────────┐                         │
    │              │   View All Posts    │                         │
    │              │   (All Clients)     │                         │
    │              └──────────┬──────────┘                         │
    └─────────────────────────┼────────────────────────────────────┘
                              │
         ┌────────────────────┼────────────────────┐
         │                    │                    │
         ▼                    ▼                    ▼
    ┌─────────┐         ┌─────────┐         ┌─────────┐
    │ Create  │         │  Edit   │         │ Delete  │
    │  Post   │         │  Post   │         │  Post   │
    └─────────┘         └─────────┘         └─────────┘
         │
         ▼
    ┌─────────────────────────────────────────────────────────────┐
    │                    MANAGEMENT                                │
    │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
    │  │   Clients   │  │    Team     │  │  Settings   │         │
    │  │   CRUD ✅   │  │   CRUD ⚠️   │  │    ⚠️      │         │
    │  └─────────────┘  └─────────────┘  └─────────────┘         │
    └─────────────────────────────────────────────────────────────┘
```

### 2.2 الصلاحيات التفصيلية

| العملية | الحالة | ملاحظات |
|---------|--------|---------|
| عرض جميع العملاء | ✅ يعمل | |
| إنشاء عميل جديد | ⚠️ UI فقط | TODO في الكود |
| تعديل عميل | ⚠️ UI فقط | غير مربوط |
| حذف عميل | ⚠️ UI فقط | غير مربوط |
| عرض جميع أعضاء الفريق | ✅ يعمل | |
| إنشاء عضو جديد | ⚠️ UI فقط | TODO في الكود |
| تعديل عضو | ⚠️ UI فقط | غير مربوط |
| حذف عضو | ⚠️ UI فقط | غير مربوط |
| ربط عضو بعميل | ❌ غير موجود | يحتاج `team_member_clients` |
| عرض جميع البوستات | ✅ يعمل | |
| إنشاء بوست | ✅ يعمل | |
| تعديل أي بوست | ✅ يعمل | |
| حذف أي بوست | ✅ يعمل | |
| تغيير حالة أي بوست | ✅ يعمل | |
| فتح قفل بوست | ✅ يعمل | |

---

## 3. Manager Flow (المشرف)

### 3.1 مخطط التدفق

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                             MANAGER FLOW                                     │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌──────────┐
    │  Login   │
    └────┬─────┘
         │
         ▼
    ┌──────────────────────────────────────────────────────────────┐
    │                      DASHBOARD                                │
    │              (Same as Admin - All Views)                      │
    └──────────────────────────────────────────────────────────────┘
         │
         ▼
    ┌──────────────────────────────────────────────────────────────┐
    │                   POST MANAGEMENT                             │
    │                                                               │
    │   ┌─────────────────────────────────────────────────────┐   │
    │   │              Workflow Control                        │   │
    │   │                                                      │   │
    │   │   idea → draft → design → internal_review            │   │
    │   │                              ↓                       │   │
    │   │                        client_review ←───────────┐   │   │
    │   │                              ↓                   │   │   │
    │   │                    ┌────────┴────────┐          │   │   │
    │   │                    ↓                 ↓          │   │   │
    │   │               approved          rejected ───────┘   │   │
    │   │                    ↓                                │   │
    │   │               scheduled                             │   │
    │   │                    ↓                                │   │
    │   │                 posted                              │   │
    │   └─────────────────────────────────────────────────────┘   │
    │                                                               │
    │   Key Actions:                                                │
    │   • إرسال للمراجعة الداخلية                                   │
    │   • إرسال لمراجعة العميل                                      │
    │   • قفل/فتح البوست                                           │
    │   • إسناد للكاتب/المصمم                                       │
    └──────────────────────────────────────────────────────────────┘
```

### 3.2 الصلاحيات التفصيلية

| العملية | الحالة | ملاحظات |
|---------|--------|---------|
| عرض جميع العملاء | ✅ يعمل | |
| إنشاء عميل | ⚠️ UI فقط | |
| عرض أعضاء الفريق | ✅ يعمل | |
| إسناد عضو لعميل | ❌ غير موجود | |
| عرض جميع البوستات | ✅ يعمل | |
| إنشاء بوست | ✅ يعمل | |
| تعديل أي بوست | ✅ يعمل | |
| حذف بوست | ✅ يعمل | |
| إرسال للمراجعة | ✅ يعمل | |
| تغيير الحالة | ✅ يعمل | |
| قفل/فتح البوست | ✅ يعمل | |

---

## 4. Writer Flow (كاتب المحتوى)

### 4.1 مخطط التدفق

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              WRITER FLOW                                     │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌──────────┐
    │  Login   │
    └────┬─────┘
         │
         ▼
    ┌──────────────────────────────────────────────────────────────┐
    │                      DASHBOARD                                │
    │         (Should see only assigned clients' posts)             │
    │                    ⚠️ Currently sees ALL                      │
    └──────────────────────────────────────────────────────────────┘
         │
         ▼
    ┌──────────────────────────────────────────────────────────────┐
    │                   WRITER ACTIONS                              │
    │                                                               │
    │   ┌─────────────────────────────────────────────────────┐   │
    │   │              Allowed Workflow                        │   │
    │   │                                                      │   │
    │   │   idea ←→ draft ←→ design → internal_review          │   │
    │   │                                                      │   │
    │   │   ❌ Cannot go to: client_review, approved, etc.     │   │
    │   └─────────────────────────────────────────────────────┘   │
    │                                                               │
    │   Allowed:                                                    │
    │   ✅ إنشاء بوست جديد (idea/draft)                            │
    │   ✅ تعديل بوست غير مقفل                                     │
    │   ✅ تغيير الحالة (idea ↔ draft ↔ design → internal_review)  │
    │   ✅ إضافة تعليق داخلي                                       │
    │                                                               │
    │   Not Allowed:                                                │
    │   ❌ تعديل بوست مقفل                                         │
    │   ❌ إرسال لمراجعة العميل                                     │
    │   ❌ الموافقة/الرفض                                          │
    │   ❌ حذف بوست                                                │
    └──────────────────────────────────────────────────────────────┘
```

### 4.2 الصلاحيات التفصيلية

| العملية | المتوقع | الحالي | المشكلة |
|---------|---------|--------|---------|
| عرض بوستات العملاء المسندين | ✅ | ❌ يرى الكل | RLS ضعيف |
| إنشاء بوست | ✅ | ✅ | |
| تعديل بوست غير مقفل | ✅ | ⚠️ | لا يتحقق من الإسناد |
| تعديل بوست مقفل | ❌ | ⚠️ | يعتمد على RLS فقط |
| تغيير الحالة (محدود) | ✅ | ⚠️ | Workflow موجود لكن API يستخدم admin |
| إضافة تعليق داخلي | ✅ | ⚠️ | UI موجود، غير مربوط |
| حذف بوست | ❌ | ⚠️ | يعتمد على RLS |

---

## 5. Designer Flow (المصمم)

### 5.1 مخطط التدفق

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                             DESIGNER FLOW                                    │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌──────────┐
    │  Login   │
    └────┬─────┘
         │
         ▼
    ┌──────────────────────────────────────────────────────────────┐
    │                      DASHBOARD                                │
    │         (Should see only assigned clients' posts)             │
    │                    ⚠️ Currently sees ALL                      │
    └──────────────────────────────────────────────────────────────┘
         │
         ▼
    ┌──────────────────────────────────────────────────────────────┐
    │                  DESIGNER ACTIONS                             │
    │                                                               │
    │   Allowed:                                                    │
    │   ✅ عرض البوستات المسندة                                    │
    │   ✅ تعديل design_notes                                      │
    │   ✅ رفع الملفات والتصاميم                                   │
    │   ✅ إضافة تعليق داخلي                                       │
    │   ✅ تغيير الحالة (design ↔ internal_review)                 │
    │                                                               │
    │   Not Allowed:                                                │
    │   ❌ تعديل النص الرئيسي                                      │
    │   ❌ تعديل بوست مقفل                                         │
    │   ❌ إرسال لمراجعة العميل                                     │
    │   ❌ الموافقة/الرفض                                          │
    └──────────────────────────────────────────────────────────────┘
```

### 5.2 الصلاحيات التفصيلية

| العملية | المتوقع | الحالي | المشكلة |
|---------|---------|--------|---------|
| عرض بوستات العملاء المسندين | ✅ | ❌ يرى الكل | RLS ضعيف |
| تعديل design_notes | ✅ | ✅ | |
| رفع ملفات | ✅ | ❌ UI فقط | Storage غير مربوط |
| إضافة تعليق داخلي | ✅ | ⚠️ | UI موجود، غير مربوط |
| تعديل بوست مقفل | ❌ | ⚠️ | يعتمد على RLS |

---

## 6. Client Flow (العميل) ❌ غير موجود

### 6.1 مخطط التدفق المطلوب

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              CLIENT FLOW                                     │
│                         ❌ NOT IMPLEMENTED                                   │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌──────────┐
    │  Login   │
    └────┬─────┘
         │
         ▼
    ┌──────────────────────────────────────────────────────────────┐
    │                    CLIENT PORTAL                              │
    │                   (To be created)                             │
    │                                                               │
    │   ┌─────────────────────────────────────────────────────┐   │
    │   │              Monthly Plan View                       │   │
    │   │                                                      │   │
    │   │   • Calendar view of scheduled posts                 │   │
    │   │   • Grid view of all posts                          │   │
    │   │   • Filter by status                                │   │
    │   └─────────────────────────────────────────────────────┘   │
    │                                                               │
    │   ┌─────────────────────────────────────────────────────┐   │
    │   │              Post Review                             │   │
    │   │                                                      │   │
    │   │   • View post details (read-only)                   │   │
    │   │   • View client-scope comments                      │   │
    │   │   • Add comment                                     │   │
    │   │   • Approve / Reject with note                      │   │
    │   └─────────────────────────────────────────────────────┘   │
    │                                                               │
    │   Allowed:                                                    │
    │   ✅ عرض خطة الشهر                                           │
    │   ✅ عرض تفاصيل البوست                                       │
    │   ✅ إضافة تعليق (client scope)                              │
    │   ✅ الموافقة على بوست في حالة client_review                 │
    │   ✅ رفض بوست مع سبب                                         │
    │                                                               │
    │   Not Allowed:                                                │
    │   ❌ تعديل أي محتوى                                          │
    │   ❌ تغيير التاريخ                                           │
    │   ❌ تغيير الحالة (إلا approve/reject)                       │
    │   ❌ رؤية تعليقات internal                                   │
    │   ❌ الوصول للوحة التحكم الرئيسية                            │
    └──────────────────────────────────────────────────────────────┘
```

### 6.2 ما يجب إنشاؤه

| العنصر | الوصف | الأولوية |
|--------|-------|----------|
| `/client-portal` route | صفحة البوابة الرئيسية | 🔴 عالية |
| `ClientPortalContent` component | المكون الرئيسي | 🔴 عالية |
| `ClientPostView` component | عرض البوست للعميل | 🔴 عالية |
| `ApprovalPanel` component | لوحة الموافقة/الرفض | 🔴 عالية |
| Middleware redirect | توجيه العميل لبوابته | 🔴 عالية |

---

## 7. مقارنة الحالة الحالية vs المطلوبة

### 7.1 جدول المقارنة

| الميزة | Admin | Manager | Writer | Designer | Client |
|--------|-------|---------|--------|----------|--------|
| **الحالي** |
| الوصول للـ Dashboard | ✅ | ✅ | ✅ | ✅ | ✅ ❌ |
| رؤية كل العملاء | ✅ | ✅ | ✅ ❌ | ✅ ❌ | ✅ ❌ |
| إنشاء بوست | ✅ | ✅ | ✅ | ⚠️ | ❌ |
| تعديل أي بوست | ✅ | ✅ | ⚠️ | ⚠️ | ❌ |
| الموافقة/الرفض | ✅ | ✅ | ❌ | ❌ | ⚠️ |
| **المطلوب** |
| الوصول للـ Dashboard | ✅ | ✅ | ✅ | ✅ | ❌ |
| رؤية كل العملاء | ✅ | ✅ | ❌ | ❌ | ❌ |
| إنشاء بوست | ✅ | ✅ | ✅ | ❌ | ❌ |
| تعديل أي بوست | ✅ | ✅ | ❌ | ❌ | ❌ |
| الموافقة/الرفض | ✅ | ✅ | ❌ | ❌ | ✅ |

### 7.2 الفجوات الرئيسية

1. **Client Portal غير موجود** - العميل يصل للـ Dashboard العادي
2. **Writer/Designer يرون كل العملاء** - لا يوجد tenant isolation
3. **Workflow غير مُطبق بشكل صحيح** - API يستخدم دور ثابت
4. **التعليقات غير مربوطة** - UI فقط
5. **رفع الملفات غير مربوط** - UI فقط

---

## 8. User Stories للتنفيذ

### 8.1 Client Portal Stories

```
US-001: As a Client, I want to see only my monthly plan
  - Given I am logged in as a client
  - When I access the portal
  - Then I see only my posts for the current month

US-002: As a Client, I want to approve a post
  - Given a post is in "client_review" status
  - When I click "Approve"
  - Then the post status changes to "approved"
  - And the post becomes locked

US-003: As a Client, I want to reject a post with feedback
  - Given a post is in "client_review" status
  - When I click "Reject" and enter a reason
  - Then the post status changes to "rejected"
  - And my feedback is saved

US-004: As a Client, I want to add a comment
  - Given I am viewing a post
  - When I add a comment
  - Then the comment is saved with "client" scope
  - And the team can see it
```

### 8.2 Tenant Isolation Stories

```
US-005: As a Writer, I want to see only my assigned clients
  - Given I am assigned to Client A and Client B
  - When I view the dashboard
  - Then I see only posts from Client A and Client B

US-006: As a Designer, I want to see only my assigned clients
  - Given I am assigned to Client A
  - When I view the dashboard
  - Then I see only posts from Client A
```

---

## 9. ملخص الإصلاحات المطلوبة

| الأولوية | الإصلاح | الجهد المقدر |
|----------|---------|--------------|
| 🔴 عالية | إنشاء Client Portal | 4-6 ساعات |
| 🔴 عالية | Middleware role redirect | 1-2 ساعة |
| 🔴 عالية | إصلاح tenant isolation | 2-3 ساعات |
| 🟡 متوسطة | ربط التعليقات | 1-2 ساعة |
| 🟡 متوسطة | ربط رفع الملفات | 3-4 ساعات |
| 🟢 منخفضة | إسناد المهام UI | 2 ساعات |
